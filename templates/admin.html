<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin - OddsMtaani</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        min-height: 100vh;
        background: linear-gradient(135deg, #050a1f, #0d1530);
        color: #ffffff;
        padding: 2rem;
      }
      .card {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(10, 26, 255, 0.3);
        backdrop-filter: blur(12px);
      }
      .table {
        color: #ffffff;
      }
      .table-dark {
        --bs-table-bg: rgba(10, 26, 255, 0.1);
      }
      .btn-sm {
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">üîê Admin Dashboard</h1>

      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card p-3">
            <h6>Pending Payments</h6>
            <h2>{{ pending|length }}</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3">
            <h6>Confirmed Payments</h6>
            <h2>{{ confirmed|length }}</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3">
            <h6>Total Revenue</h6>
            <h2>KES {{ confirmed|length * entry_fee }}</h2>
          </div>
        </div>
      </div>

      <div class="card p-4 mb-4">
        <h4>‚è≥ Pending Payments</h4>
        {% if pending %}
        <table class="table table-dark">
          <thead>
            <tr>
              <th>Payment ID</th>
              <th>Phone</th>
              <th>Amount</th>
              <th>Time</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for id, payment in pending.items() %}
            <tr id="row-{{ id }}">
              <td><strong>{{ id }}</strong></td>
              <td>{{ payment.phone }}</td>
              <td>KES {{ payment.amount }}</td>
              <td>{{ payment.timestamp.split('T')[1].split('.')[0] }}</td>
              <td>
                <button class="btn btn-success btn-sm" onclick="confirmPayment('{{ id }}')">‚úì Confirm</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-muted">No pending payments</p>
        {% endif %}
      </div>

      <div class="card p-4 mb-4">
        <h4>‚úÖ Confirmed Payments</h4>
        {% if confirmed %}
        <table class="table table-dark">
          <thead>
            <tr>
              <th>Payment ID</th>
              <th>Phone</th>
              <th>Amount</th>
              <th>Confirmed At</th>
            </tr>
          </thead>
          <tbody>
            {% for id, payment in confirmed.items() %}
            <tr>
              <td><strong>{{ id }}</strong></td>
              <td>{{ payment.phone }}</td>
              <td>KES {{ payment.amount }}</td>
              <td>{{ payment.confirmed_at.split('T')[1].split('.')[0] if payment.confirmed_at else 'N/A' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-muted">No confirmed payments yet</p>
        {% endif %}
      </div>

      <div class="card p-4">
        <h4>üí∞ Send Payout to Winner</h4>
        <form action="/payout" method="post" class="row g-3">
          <div class="col-md-6">
            <input name="phone" class="form-control" placeholder="Winner phone (+2547...)" required>
          </div>
          <div class="col-md-3">
            <input name="amount" type="number" class="form-control" placeholder="Amount" required>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-success w-100">Record Payout</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function confirmPayment(paymentId) {
        if (!confirm(`Confirm payment ${paymentId}?`)) return;
        
        fetch(`/admin/confirm/${paymentId}`, { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              document.getElementById(`row-${paymentId}`).style.background = 'rgba(0,255,0,0.2)';
              setTimeout(() => location.reload(), 1000);
            } else {
              alert(data.message);
            }
          });
      }
    </script>
  </body>
</html>
